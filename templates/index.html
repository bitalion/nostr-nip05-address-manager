<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIP-05 Registration</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/static/css/vendor/all.min.css">
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <style>
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 100 900;
            font-display: swap;
            src: url('/static/fonts/inter-v20-latin-ext.woff2') format('woff2');
            unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 100 900;
            font-display: swap;
            src: url('/static/fonts/inter-v20-latin.woff2') format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        html {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: "cv02", "cv03", "cv11", "ss01";
            background-color: #08080f;
            height: 100%;
            overflow: hidden;
        }
        #snapContainer {
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        .snap-section {
            min-height: 100vh;
            scroll-snap-align: start;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .glow-orb {
            position: fixed;
            bottom: -120px;
            right: -120px;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(109,40,255,0.18) 0%, rgba(109,40,255,0.06) 45%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        #qrCode {
            position: relative;
            display: inline-block;
        }
        #qrCanvas {
            display: block;
        }
        #qrLogo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #invoiceWrapper {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <!-- Background glow -->
    <div class="glow-orb" aria-hidden="true"></div>

    <!-- Top Menu -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-black/30 backdrop-blur-2xl border-b border-white/[0.06]">
        <div class="w-full px-3 sm:px-6 py-2 sm:py-3 flex items-center justify-end gap-5 sm:gap-7">

            <!-- Desktop menu items (hidden on mobile) -->
            <a href="#" class="hidden sm:inline text-slate-400 text-sm font-medium hover:text-white transition-colors duration-200" id="menuNip05">NIP-05</a>
            <a href="#" class="hidden sm:inline text-slate-400 text-sm font-medium hover:text-white transition-colors duration-200" id="menuFaq"><span id="menuFaqLabel">FAQ</span></a>

            <!-- Status Indicator -->
            <div class="flex items-center gap-1.5" id="statusContainer">
                <span id="statusDot" class="w-2 h-2 flex-shrink-0 rounded-full bg-red-500 animate-pulse"></span>
                <span id="statusText" class="text-xs text-slate-400 hidden sm:inline">Checking...</span>
            </div>

            <!-- Language Selector -->
            <div class="flex items-center gap-1.5">
                <button id="langEN" class="text-xs font-semibold text-white transition-colors duration-200" data-lang="en">EN</button>
                <span class="text-slate-600 text-xs select-none">/</span>
                <button id="langES" class="text-xs font-semibold text-slate-500 hover:text-white transition-colors duration-200" data-lang="es">ES</button>
            </div>

            <!-- Hamburger button (mobile only) -->
            <button id="mobileMenuBtn" class="sm:hidden flex items-center justify-center w-8 h-8 text-white hover:text-[#6C27FF] transition-colors">
                <i id="hamburgerIcon" class="fa-solid fa-bars text-base"></i>
            </button>
        </div>

        <!-- Mobile dropdown -->
        <div id="mobileMenu" class="hidden sm:hidden border-t border-white/[0.06] bg-black/60 backdrop-blur-2xl px-4 py-2">
            <a href="#" id="menuNip05M" class="flex items-center gap-3 text-white text-sm font-medium hover:text-[#6C27FF] transition-colors py-2.5 border-b border-slate-700/40">
                <i class="fa-solid fa-at w-4 text-center text-[#6C27FF]"></i><span>NIP-05</span>
            </a>
            <a href="#" id="menuFaqM" class="flex items-center gap-3 text-white text-sm font-medium hover:text-[#6C27FF] transition-colors py-2.5 border-b border-slate-700/40">
                <i class="fa-solid fa-circle-question w-4 text-center text-slate-400"></i><span id="menuFaqLabelM">FAQ</span>
            </a>
        </div>
    </nav>

    <div id="snapContainer">

        <!-- Sección 1: Registro NIP-05 -->
        <section id="section-nip05" class="snap-section justify-center pt-14 sm:pt-16">

    <div class="w-full max-w-2xl mx-auto px-4">
    <!-- Hero text -->
    <div id="heroSection" class="text-center mb-6 sm:mb-8">
        <p class="text-2xl sm:text-3xl md:text-4xl font-light text-slate-400 tracking-tight leading-[1.15]">
            <span id="heroPrefix">Registra tu </span><span class="bg-gradient-to-r from-violet-400 to-violet-200 bg-clip-text text-transparent font-extrabold">NIP-05</span>
        </p>
        <p class="mt-1 sm:mt-2">
            <span id="heroMid" class="text-sm sm:text-base font-light text-slate-500 tracking-wide">en el dominio </span><span class="text-white text-lg sm:text-xl md:text-2xl font-bold tracking-tight">{{ domain }}</span>
        </p>
    </div>

            <!-- Registration Section -->
            <div id="registrationSection" class="mb-6">
                
                <form id="registrationForm" class="space-y-6">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="username" class="block text-[10px] sm:text-xs font-semibold text-slate-400 uppercase tracking-widest" id="label-username">
                            NIP-05 Username
                        </label>
                        <span class="text-[10px] font-medium text-slate-500 tracking-wide">{{ price_sats }} ⚡</span>
                    </div>
                    <div class="relative">
                        <input
                            type="text"
                            id="username"
                            name="username"
                            required
                            maxlength="30"
                            class="w-full pl-4 pr-40 py-2.5 sm:py-3 bg-white/5 border border-white/10 rounded-xl text-white text-sm placeholder-slate-500 focus:outline-none focus:border-violet-500/50 focus:bg-white/[0.08] transition-all"
                            placeholder="username"
                        >
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm pointer-events-none select-none whitespace-nowrap">@{{ domain }}</span>
                    </div>
                    <p id="availabilityMsg" class="text-xs mt-1 hidden"></p>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="pubkey" class="block text-[10px] sm:text-xs font-semibold text-slate-400 uppercase tracking-widest" id="label-pubkey">
                            Public Key (npub)
                        </label>
                        <a href="#" id="toggleHex" class="text-xs text-white hover:text-[#6C27FF] transition-colors">
                            <i class="fa-solid fa-code mr-1"></i><span id="toggleHexText">Hex</span>
                        </a>
                    </div>
                    <input
                        type="text"
                        id="pubkey"
                        name="pubkey"
                        required
                        class="w-full px-4 py-2.5 sm:py-3 bg-white/5 border border-white/10 rounded-xl text-white text-sm placeholder-slate-500 focus:outline-none focus:border-violet-500/50 focus:bg-white/[0.08] transition-all"
                        placeholder="npub1..."
                    >
                    <p id="pubkeyStatus" class="text-xs mt-1 hidden"></p>
                </div>

                <div id="hexSection" class="hidden">
                    <label for="hexkey" class="block text-[10px] sm:text-xs font-semibold text-slate-400 uppercase tracking-widest mb-2" id="label-hexkey">
                        Hexadecimal Format
                    </label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="hexkey"
                            readonly
                            class="flex-1 px-4 py-2.5 sm:py-3 bg-white/5 border border-white/10 rounded-xl text-white text-xs sm:text-sm placeholder-slate-500 focus:outline-none focus:border-violet-500/50 transition-all cursor-pointer break-all"
                            placeholder="Hexadecimal will appear here..."
                        >
                        <button
                            type="button"
                            id="copyHexBtn"
                            class="px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-400 hover:text-white rounded-xl transition-all disabled:opacity-30 flex-shrink-0"
                            disabled
                        >
                            <i class="fa-solid fa-copy"></i>
                        </button>
                    </div>
                </div>

                <hr class="border-white/10">

                <button
                    type="submit"
                    id="submitBtn"
                    class="block mx-auto w-52 py-3 px-4 bg-violet-600 hover:bg-violet-500 text-white text-sm font-semibold tracking-wide rounded-xl transition-colors duration-200"
                >
                    <span id="btnText">Proceed to Payment</span>
                    <span id="btnLoading" class="hidden">
                        <i class="fa-solid fa-circle-notch fa-spin mr-2"></i><span id="btnLoadingText">Processing...</span>
                    </span>
                </button>
            </form>

            <div id="paymentSection" class="hidden mt-4 sm:mt-6">
                <div class="border-t border-white/10 pt-4 sm:pt-6">
                    <h3 class="text-base sm:text-lg font-semibold tracking-tight text-white mb-4 sm:mb-5" id="payment-title">
                        <i class="fa-brands fa-bitcoin text-violet-400 mr-2"></i>
                        <span id="payment-title-text">Lightning Payment</span>
                    </h3>
                    <p class="text-slate-500 text-xs font-medium tracking-wide mb-4" id="payment-scan">Scan this QR code to pay:</p>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-4 sm:mb-5">
                        <div id="qrCode" class="flex justify-center"></div>
                        <div class="flex-1 w-full">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest mb-2" id="invoiceLabel">Invoice:</p>
                            <div
                                id="invoiceWrapper"
                                class="cursor-pointer bg-white/5 hover:bg-white/[0.08] border border-white/10 rounded-xl p-3 transition-colors"
                            >
                                <p class="text-xs text-slate-500 break-all font-mono" id="invoiceText"></p>
                            </div>
                            <p class="text-xs text-slate-600 mt-2 hidden" id="copyHint">
                                <i class="fa-solid fa-copy mr-1"></i>Tap to copy
                            </p>
                        </div>
                    </div>
                    <button
                        id="checkPaymentBtn"
                        class="block mx-auto w-52 py-2.5 sm:py-3 px-4 bg-green-600 hover:bg-green-500 text-white text-sm font-semibold rounded-xl transition-colors duration-200 disabled:opacity-40"
                        disabled
                    >
                        <i class="fa-solid fa-circle-notch fa-spin mr-2"></i>
                        <span id="checkPaymentText">Waiting for payment...</span>
                    </button>
                    <p class="text-[11px] text-slate-500 mt-2 text-center leading-relaxed" id="payment-auto">The verification is automatic. After payment, it will appear here.</p>
                    <button
                        type="button"
                        id="backToFormBtn"
                        class="block mx-auto w-52 mt-3 py-2.5 sm:py-3 px-4 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 text-sm font-semibold rounded-xl transition-colors duration-200"
                    >
                        <i class="fa-solid fa-arrow-left mr-2"></i><span id="backToFormText">Register another NIP-05</span>
                    </button>
                </div>
            </div>

            <div id="successSection" class="hidden mt-4 sm:mt-6">
                <div class="border-t border-slate-700 pt-4 sm:pt-6">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 rounded-full bg-green-500/20 mb-3 sm:mb-4">
                            <i class="fa-solid fa-check text-2xl sm:text-3xl text-green-400"></i>
                        </div>
                        <h3 class="text-xl sm:text-2xl font-bold tracking-tight text-white mb-2" id="success-title">Registration Complete!</h3>
                        <p class="text-slate-400 text-xs sm:text-sm font-medium tracking-wide" id="success-text">Your NIP-05 identifier is:</p>
                        <p class="text-violet-400 font-mono text-base sm:text-xl font-medium break-all mt-3 tracking-tight" id="registeredNip05"></p>
                        <button
                            type="button"
                            id="newRegistrationBtn"
                            class="block mx-auto w-52 mt-4 py-2.5 sm:py-3 px-6 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 text-sm font-semibold rounded-xl transition-colors duration-200"
                        >
                            <i class="fa-solid fa-plus mr-2"></i><span id="newRegistrationText">Register another NIP-05</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="errorSection" class="hidden mt-4 sm:mt-6">
                <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-3 sm:p-4">
                    <p class="text-red-400 text-center text-sm sm:text-base break-words" id="errorMsg"></p>
                </div>
            </div>
            </div>

            <!-- Support Section -->
            <div id="supportSection">
                <!-- Support content goes here -->
            </div>
    </div><!-- end centered wrapper -->

        </section><!-- fin section-nip05 -->

        <!-- Sección 2: Últimos registros -->
        <section id="section-registrations" class="snap-section justify-center pt-14 sm:pt-16">
    <div class="w-full max-w-2xl sm:max-w-4xl mx-auto px-3 sm:px-6">
        <h2 class="text-base font-semibold tracking-tight text-slate-300 mb-4" id="lastRegsTitle">Últimos registros</h2>
        <!-- Column headers -->
        <div class="grid grid-cols-[1fr_1fr_2.5rem_2.5rem] sm:grid-cols-[1fr_2fr_2.5rem_2.5rem] gap-3 sm:gap-6 pb-2">
            <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest" id="colHeaderNip05">NIP-05</p>
            <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest" id="colHeaderPubkey">Clave pública</p>
            <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest text-center" id="colHeaderPaid">Pagado</p>
            <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest text-center" id="colHeaderStatus">Estado</p>
        </div>
        <!-- Rows -->
        <div id="ultimosRegistros" class="divide-y divide-slate-700/50">
            <div class="flex items-center gap-2 py-4 text-slate-500 text-sm">
                <i class="fa-solid fa-circle-notch fa-spin text-slate-600 text-xs"></i>
                <span>Cargando…</span>
            </div>
        </div>
    </div>

        </section><!-- fin section-registrations -->

        <!-- Sección 3: FAQ -->
        <section id="section-faq" class="snap-section pt-14 sm:pt-16">
    <div class="flex-1 flex flex-col justify-center w-full max-w-2xl sm:max-w-4xl mx-auto px-3 sm:px-6 py-6 sm:py-8">
        <h2 class="text-base font-semibold tracking-tight text-slate-300 mb-1" id="faqTitle">FAQ</h2>
        <div class="divide-y divide-slate-700/50">

            <!-- Question 1 -->
            <div>
                <button id="infoToggle" type="button" class="w-full flex items-center justify-between text-left py-4 group">
                    <span class="text-white text-sm sm:text-base font-semibold group-hover:text-[#6C27FF] transition-colors pr-4 tracking-tight" id="infoTitle">¿Qué es un NIP-05?</span>
                    <i id="infoIcon" class="fa-solid fa-chevron-down text-slate-400 text-xs flex-shrink-0 transition-transform duration-200"></i>
                </button>
                <div id="infoContent" class="hidden pb-5 text-slate-400 text-sm leading-7">
                    <p id="infoDesc1">Un NIP-05 es una especificación técnica que permite a los usuarios de Nostr asociar su clave pública con un identificador basado en internet, similar a una dirección de correo electrónico.</p>
                </div>
            </div>

            <!-- Question 2 -->
            <div>
                <button id="howToggle" type="button" class="w-full flex items-center justify-between text-left py-4 group">
                    <span class="text-white text-sm sm:text-base font-semibold group-hover:text-[#6C27FF] transition-colors pr-4 tracking-tight" id="howTitle">¿Cómo funciona?</span>
                    <i id="howIcon" class="fa-solid fa-chevron-down text-slate-400 text-xs flex-shrink-0 transition-transform duration-200"></i>
                </button>
                <div id="howContent" class="hidden pb-5 text-slate-400 text-sm leading-7">
                    <p id="howDesc">Es un proceso de verificación simple. Los clientes de Nostr verifican automáticamente buscando un archivo especial llamado nostr.json en el dominio especificado.</p>
                </div>
            </div>

            <!-- Question 3 -->
            <div>
                <button id="whyToggle" type="button" class="w-full flex items-center justify-between text-left py-4 group">
                    <span class="text-white text-sm sm:text-base font-semibold group-hover:text-[#6C27FF] transition-colors pr-4 tracking-tight" id="whyTitle">¿Por qué deberías tener uno?</span>
                    <i id="whyIcon" class="fa-solid fa-chevron-down text-slate-400 text-xs flex-shrink-0 transition-transform duration-200"></i>
                </button>
                <div id="whyContent" class="hidden pb-5 text-slate-400 text-sm space-y-4">
                    <div>
                        <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest mb-1" id="whyBenefit1">Identidad legible</p>
                        <p id="whyDesc1" class="text-slate-400 text-sm leading-7">Puedes compartir algo tan sencillo como tunombre@ejemplo.com en lugar de una clave pública compleja.</p>
                    </div>
                    <div>
                        <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest mb-1" id="whyBenefit2">Señal de confianza</p>
                        <p id="whyDesc2" class="text-slate-400 text-sm leading-7">Obtienes un distintivo de verificación en la mayoría de los clientes de Nostr.</p>
                    </div>
                    <div>
                        <p class="text-[10px] sm:text-[11px] font-semibold text-slate-400 uppercase tracking-widest mb-1" id="whyBenefit3">Protección contra suplantación</p>
                        <p id="whyDesc3" class="text-slate-400 text-sm leading-7">Es la mejor manera de demostrar que tu cuenta de Nostr te pertenece auténticamente.</p>
                    </div>
                </div>
            </div>

            <!-- Question 4 -->
            <div>
                <button id="activationToggle" type="button" class="w-full flex items-center justify-between text-left py-4 group">
                    <span class="text-white text-sm sm:text-base font-semibold group-hover:text-[#6C27FF] transition-colors pr-4 tracking-tight" id="activationTitle">¿Qué tiempo tarda en activarse mi NIP-05?</span>
                    <i id="activationIcon" class="fa-solid fa-chevron-down text-slate-400 text-xs flex-shrink-0 transition-transform duration-200"></i>
                </button>
                <div id="activationContent" class="hidden pb-5 text-slate-400 text-sm leading-7">
                    <p id="activationDesc">La activación de tu NIP-05 suele ser casi instantánea tras confirmar el pago. Sin embargo, debido a la propagación en la red, podría tardar unos minutos en reflejarse.</p>
                    <p class="mt-3" id="activationDesc2">Si no lo ves activo de inmediato, verifica que tu cliente de Nostr esté correctamente conectado a los relays, ya que ellos son los encargados de validar la identidad. Si después de unos minutos el problema persiste, no dudes en contactarnos.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Nostrich mascot -->
    <img
        src="/static/images/nostrich.png"
        alt="Nostrich"
        class="hidden md:block fixed bottom-0 right-0 object-contain pointer-events-none z-10 w-[300px] h-[300px] opacity-80"
    >

        <!-- Footer -->
        <footer class="border-t border-white/10 py-6 px-4 bg-black/20 mt-auto">
            <div class="text-center flex flex-wrap items-center justify-center gap-2 sm:gap-4">
                <span class="text-slate-600 text-xs">
                    <span id="footerText">Made with ❤️ by Cuba Bitcoin 2026</span>
                </span>
                <span class="text-slate-700 text-xs">·</span>
                <a href="https://github.com/bitalion/nostr-nip05-address-manager" target="_blank" class="text-slate-600 text-xs hover:text-slate-400 transition-colors flex items-center gap-1">
                    <i class="fa-brands fa-github"></i>
                    <span id="sourceCodeText">Source Code</span>
                </a>
            </div>
        </footer>

        </section><!-- fin section-faq -->

    </div><!-- fin #snapContainer -->

    <script src="/static/js/qrious.min.js"></script>
    <script>
        const DOMAIN = "{{ domain }}";

        // Translations
        const translations = {
            en: {
                title: "NIP-05 Register",
                subtitle: "Get your Nostr identifier",
                faqTitle: "FAQ",
                menuDirectory: "Directory",
                statusOnline: "Online",
                statusOffline: "Offline",
                labelUsername: "NIP-05 Username",
                usernamePlaceholder: "username",
                labelPubkey: "Public Key (npub)",
                labelHexkey: "Public Key (hex)",
                hexPlaceholder: "Hexadecimal will appear here...",
                copySuccess: "Copied!",
                btnProceed: "Proceed to Payment",
                btnProcessing: "Processing...",
                availableYes: "✓ Available",
                availableNo: "✗ Already taken",
                pubkeyRegistered: "✗ This public key is already registered",
                pubkeyValid: "✓ Valid public key",
                toggleHexShow: "Hex",
                toggleHexHide: "Hide Hex",
                paymentTitle: "Lightning Payment",
                paymentScan: "Scan this QR code to pay:",
                checkPaymentWaiting: "Waiting for payment...",
                paymentAuto: "The verification is automatic. After payment, it will appear here.",
                copyInvoice: "Tap to copy",
                copyInvoiceDone: "Copied!",
                tapToCopy: "Tap to copy",
                successTitle: "Registration Complete!",
                successText: "Your NIP-05 identifier is:",
                errorTitle: "Error",
                errorCreateInvoice: "Error creating invoice",
                errorPaymentFailed: "Payment verification failed",
                paymentExpired: "Invoice expired. Please start again.",
                invoicePending: "You have a pending invoice. Please complete the payment.",
                invoiceAlreadyPaid: "This invoice has already been paid. Processing your registration...",
                backToForm: "Register another NIP-05",
                footer: "Made with ❤️ by Cuba Bitcoin 2026",
                sourceCode: "Source Code",
                infoTitle: "What is a NIP-05?",
                infoDesc1: "A NIP-05 is a technical specification (Nostr Implementation Possibility) that allows Nostr users to associate their public key (that long string of numbers and letters starting with \"npub\") with an internet-based identifier, similar to an email address, like user@example.com",
                howTitle: "How does it work?",
                howDesc: "It's a simple verification process. When you set up a NIP-05 in your profile, Nostr clients (the applications you use) automatically verify that you own that identity. They do this by looking for a special file called nostr.json in the domain you specified. If your public key appears in that file associated with your username, verification is successful!",
                whyTitle: "Why should you have one?",
                whyBenefit1: "Readable identity",
                whyDesc1: "Instead of sharing a complex public key like npub1..., you can share something as simple as yourname@example.com. This makes it easier for others to find you and add you.",
                whyBenefit2: "Trust signal",
                whyDesc2: "By having a NIP-05, you get a verification badge (a \"check\" or seal) in most Nostr clients. This is a signal to the community that you are a real user and not a bot or imposter.",
                whyBenefit3: "Protection against impersonation",
                whyDesc3: "If you are a well-known person, company or brand, having a NIP-05 on your own domain (e.g. ceo@mycompany.com) is the best way to prove that your Nostr account authentically belongs to you, protecting it against identity theft.",
                activationTitle: "How long does it take for my NIP-05 to activate?",
                activationDesc: "Your NIP-05 activation is usually almost instantaneous after confirming payment. However, due to network propagation, it may take a few minutes to reflect.",
                activationDesc2: "If you don't see it active immediately, make sure your Nostr client is properly connected to the relays, as they are responsible for validating the identity. If the problem persists after a few minutes, don't hesitate to contact us.",
                heroPrefix: "Register your",
                heroMid: "on the domain",
                lastRegsTitle: "Latest registrations",
                colPubkey: "Public key",
                colStatus: "Status",
                colPaid: "Paid",
                noRegs: "No registrations yet."
            },
            es: {
                title: "Registro NIP-05",
                subtitle: "Obtén tu identificador Nostr",
                faqTitle: "FAQ",
                menuDirectory: "Directorio",
                statusOnline: "En línea",
                statusOffline: "Sin conexión",
                labelUsername: "Usuario NIP-05",
                usernamePlaceholder: "nombre de usuario",
                labelPubkey: "Clave Pública (npub)",
                labelHexkey: "Clave Pública (hex)",
                hexPlaceholder: "El formato hexadecimal aparecerá aquí...",
                copySuccess: "¡Copiado!",
                btnProceed: "Proceder al Pago",
                btnProcessing: "Procesando...",
                availableYes: "✓ Disponible",
                availableNo: "✗ Ya en uso",
                pubkeyRegistered: "✗ Esta clave pública ya está registrada",
                pubkeyValid: "✓ Clave pública válida",
                toggleHexShow: "Hex",
                toggleHexHide: "Ocultar Hex",
                paymentTitle: "Pago Lightning",
                paymentScan: "Escanea este código QR para pagar:",
                checkPaymentWaiting: "Esperando pago...",
                paymentAuto: "La verificación es automática. Después de pagar, aparecerá aquí.",
                copyInvoice: "Toca para copiar",
                copyInvoiceDone: "¡Copiado!",
                tapToCopy: "Toca para copiar",
                successTitle: "¡Registro completado!",
                successText: "Tu identificador NIP-05 es:",
                errorTitle: "Error",
                errorCreateInvoice: "Error al crear la factura",
                errorPaymentFailed: "Error en la verificación de pago",
                paymentExpired: "Factura expirada. Por favor, comienza de nuevo.",
                invoicePending: "Tienes una factura pendiente. Por favor, completa el pago.",
                invoiceAlreadyPaid: "Esta factura ya ha sido pagada. Procesando tu registro...",
                backToForm: "Registrar otro NIP-05",
                footer: "Hecho con ❤️ por Cuba Bitcoin 2026",
                sourceCode: "Código Fuente",
                infoTitle: "¿Qué es un NIP-05?",
                infoDesc1: "Un NIP-05 es una especificación técnica (Nostr Implementation Possibility) que permite a los usuarios de Nostr asociar su clave pública (esa cadena larga de números y letras que empieza con \"npub\") con un identificador basado en internet, similar a una dirección de correo electrónico, como ejemplo@dominio.com",
                howTitle: "¿Cómo funciona?",
                howDesc: "Es un proceso de verificación simple. Cuando configuras un NIP-05 en tu perfil, los clientes de Nostr (las aplicaciones que usas) verifican automáticamente que eres el dueño de esa identidad. Lo hacen buscando un archivo especial llamado nostr.json en el dominio que especificaste. Si en ese archivo aparece tu clave pública asociada a tu nombre de usuario, ¡la verificación es exitosa!",
                whyTitle: "¿Por qué deberías tener uno?",
                whyBenefit1: "Identidad legible",
                whyDesc1: "En lugar de compartir una clave pública compleja como npub1..., puedes compartir algo tan sencillo como tunombre@ejemplo.com. Esto facilita que otros te encuentren y te agreguen.",
                whyBenefit2: "Señal de confianza",
                whyDesc2: "Al poseer un NIP-05, obtienes un distintivo de verificación (un \"check\" o sello) en la mayoría de los clientes de Nostr. Esto es una señal para la comunidad de que eres un usuario real y no un bot o un impostor.",
                whyBenefit3: "Protección contra suplantación",
                whyDesc3: "Si eres una persona conocida, una empresa o una marca, tener un NIP-05 en tu propio dominio (ej. ceo@miempresa.com) es la mejor manera de demostrar que la cuenta de Nostr te pertenece auténticamente, blindándola contra la suplantación de identidad.",
                activationTitle: "¿Qué tiempo tarda en activarse mi NIP-05?",
                activationDesc: "La activación de tu NIP-05 suele ser casi instantánea tras confirmar el pago. Sin embargo, debido a la propagación en la red, podría tardar unos minutos en reflejarse.",
                activationDesc2: "Si no lo ves activo de inmediato, verifica que tu cliente de Nostr esté correctamente conectado a los relays, ya que ellos son los encargados de validar la identidad. Si después de unos minutos el problema persiste, no dudes en contactarnos.",
                heroPrefix: "Registra tu",
                heroMid: "en el dominio",
                lastRegsTitle: "Últimos registros",
                colPubkey: "Clave pública",
                colStatus: "Estado",
                colPaid: "Pagado",
                noRegs: "No hay registros aún."
            }
        };

        let currentLanguage = localStorage.getItem('language') || (navigator.language || navigator.userLanguage || 'en').split('-')[0];
        if (!['en', 'es'].includes(currentLanguage)) {
            currentLanguage = 'en';
        }


        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);

            document.getElementById('faqTitle').textContent = translations[lang].faqTitle;
            document.getElementById('label-username').textContent = translations[lang].labelUsername;
            document.getElementById('username').placeholder = translations[lang].usernamePlaceholder;
            document.getElementById('label-pubkey').textContent = translations[lang].labelPubkey;
            document.getElementById('label-hexkey').textContent = translations[lang].labelHexkey;
            document.getElementById('hexkey').placeholder = translations[lang].hexPlaceholder;
            const hexHidden = document.getElementById('hexSection') && document.getElementById('hexSection').classList.contains('hidden');
            document.getElementById('toggleHexText').textContent = hexHidden ? translations[lang].toggleHexShow : translations[lang].toggleHexHide;
            document.getElementById('btnText').textContent = translations[lang].btnProceed;
            document.getElementById('btnLoadingText').textContent = translations[lang].btnProcessing;
            document.getElementById('payment-title-text').textContent = translations[lang].paymentTitle;
            document.getElementById('payment-scan').textContent = translations[lang].paymentScan;
            document.getElementById('checkPaymentText').textContent = translations[lang].checkPaymentWaiting;
            document.getElementById('payment-auto').textContent = translations[lang].paymentAuto;
            document.getElementById('success-title').textContent = translations[lang].successTitle;
            document.getElementById('success-text').textContent = translations[lang].successText;
            document.getElementById('backToFormText').textContent = translations[lang].backToForm;
            document.getElementById('newRegistrationText').textContent = translations[lang].backToForm;
            document.getElementById('footerText').textContent = translations[lang].footer;
            document.getElementById('sourceCodeText').textContent = translations[lang].sourceCode;
            document.getElementById('infoTitle').textContent = translations[lang].infoTitle;
            document.getElementById('infoDesc1').textContent = translations[lang].infoDesc1;
            document.getElementById('howTitle').textContent = translations[lang].howTitle;
            document.getElementById('howDesc').textContent = translations[lang].howDesc;
            document.getElementById('whyTitle').textContent = translations[lang].whyTitle;
            document.getElementById('whyBenefit1').textContent = translations[lang].whyBenefit1;
            document.getElementById('whyDesc1').textContent = translations[lang].whyDesc1;
            document.getElementById('whyBenefit2').textContent = translations[lang].whyBenefit2;
            document.getElementById('whyDesc2').textContent = translations[lang].whyDesc2;
            document.getElementById('whyBenefit3').textContent = translations[lang].whyBenefit3;
            document.getElementById('whyDesc3').textContent = translations[lang].whyDesc3;
            document.getElementById('activationTitle').textContent = translations[lang].activationTitle;
            document.getElementById('activationDesc').textContent = translations[lang].activationDesc;
            document.getElementById('activationDesc2').textContent = translations[lang].activationDesc2;

            // Update language selector
            document.getElementById('langEN').className = lang === 'en' ? 'text-xs font-semibold text-white transition-colors duration-200' : 'text-xs font-semibold text-slate-500 hover:text-white transition-colors duration-200';
            document.getElementById('langES').className = lang === 'es' ? 'text-xs font-semibold text-white transition-colors duration-200' : 'text-xs font-semibold text-slate-500 hover:text-white transition-colors duration-200';
            
            // Hero text
            document.getElementById('heroPrefix').textContent = translations[lang].heroPrefix + ' ';
            document.getElementById('heroMid').textContent = translations[lang].heroMid + ' ';

            // Últimos registros headers
            document.getElementById('lastRegsTitle').textContent = translations[lang].lastRegsTitle;
            document.getElementById('colHeaderPubkey').textContent = translations[lang].colPubkey;
            document.getElementById('colHeaderStatus').textContent = translations[lang].colStatus;
            document.getElementById('colHeaderPaid').textContent = translations[lang].colPaid;

            // Status
            document.getElementById('statusText').textContent = translations[lang].statusOnline;
        }

        // Initialize language
        setLanguage(currentLanguage);

        // Check nostr.json status
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        async function checkNostrJsonStatus() {
            try {
                const response = await fetch('/.well-known/nostr.json', { method: 'GET' });
                if (response.ok) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    statusText.textContent = translations[currentLanguage].statusOnline;
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                    statusText.textContent = translations[currentLanguage].statusOffline;
                }
            } catch (error) {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                statusText.textContent = translations[currentLanguage].statusOffline;
            }
        }
        
        checkNostrJsonStatus();
        setInterval(checkNostrJsonStatus, 30000);

        document.addEventListener('click', function(event) {
            // Close mobile menu when clicking outside
            const mobileMenu = document.getElementById('mobileMenu');
            if (!document.getElementById('mobileMenuBtn').contains(event.target)) {
                mobileMenu.classList.add('hidden');
                document.getElementById('hamburgerIcon').className = 'fa-solid fa-bars text-base';
            }
        });

        // Hamburger toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const mobileMenu = document.getElementById('mobileMenu');
            const icon = document.getElementById('hamburgerIcon');
            const isOpen = !mobileMenu.classList.contains('hidden');
            mobileMenu.classList.toggle('hidden');
            icon.className = isOpen ? 'fa-solid fa-bars text-base' : 'fa-solid fa-xmark text-base';
        });

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.add('hidden');
            document.getElementById('hamburgerIcon').className = 'fa-solid fa-bars text-base';
        }

        document.getElementById('langEN').addEventListener('click', function() {
            setLanguage('en');
        });

        document.getElementById('langES').addEventListener('click', function() {
            setLanguage('es');
        });

        // Menu handlers
        function scrollToSection(sectionId) {
            const container = document.getElementById('snapContainer');
            const section = document.getElementById(sectionId);
            if (section && container) {
                container.scrollTo({ top: section.offsetTop, behavior: 'smooth' });
            }
        }

        document.getElementById('menuNip05').addEventListener('click', function(e) {
            e.preventDefault();
            scrollToSection('section-nip05');
            document.getElementById('username').focus();
        });

        document.getElementById('menuFaq').addEventListener('click', function(e) {
            e.preventDefault();
            scrollToSection('section-faq');
        });

        // Mobile menu handlers
        document.getElementById('menuNip05M').addEventListener('click', function(e) {
            e.preventDefault();
            closeMobileMenu();
            scrollToSection('section-nip05');
            document.getElementById('username').focus();
        });
        document.getElementById('menuFaqM').addEventListener('click', function(e) {
            e.preventDefault();
            closeMobileMenu();
            scrollToSection('section-faq');
        });

        // FAQ accordion helper
        function setupFaqToggle(toggleId, contentId, iconId) {
            const toggle = document.getElementById(toggleId);
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            toggle.addEventListener('click', function() {
                const isHidden = content.classList.toggle('hidden');
                icon.style.transform = isHidden ? '' : 'rotate(180deg)';
            });
        }

        setupFaqToggle('infoToggle', 'infoContent', 'infoIcon');
        setupFaqToggle('howToggle',  'howContent',  'howIcon');
        setupFaqToggle('whyToggle',  'whyContent',  'whyIcon');
        setupFaqToggle('activationToggle', 'activationContent', 'activationIcon');

        const form = document.getElementById('registrationForm');
        const usernameInput = document.getElementById('username');
        const pubkeyInput = document.getElementById('pubkey');
        const hexkeyInput = document.getElementById('hexkey');
        const copyHexBtn = document.getElementById('copyHexBtn');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        const availabilityMsg = document.getElementById('availabilityMsg');
        const pubkeyStatus = document.getElementById('pubkeyStatus');
        const paymentSection = document.getElementById('paymentSection');
        const successSection = document.getElementById('successSection');
        const errorSection = document.getElementById('errorSection');
        const errorMsg = document.getElementById('errorMsg');
        const checkPaymentBtn = document.getElementById('checkPaymentBtn');

        let currentInvoice = null;
        let username = '';
        let pubkeyHex = '';
        let paymentCheckInterval = null;
        let paymentCheckTimeout = null;
        let isChecking = false;

        async function checkAvailability() {
            const usernameVal = usernameInput.value.toLowerCase().trim();
            if (usernameVal.length < 1) return;

            try {
                const res = await fetch('/api/check-availability/' + usernameVal);
                const data = await res.json();
                
                if (data.available) {
                    availabilityMsg.textContent = translations[currentLanguage].availableYes;
                    availabilityMsg.className = 'text-xs mt-1 text-green-400';
                } else {
                    availabilityMsg.textContent = translations[currentLanguage].availableNo;
                    availabilityMsg.className = 'text-xs mt-1 text-red-400';
                }
                availabilityMsg.classList.remove('hidden');
            } catch (e) {
                console.error(e);
            }
        }

        let debounceTimer;
        usernameInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(checkAvailability, 300);
        });

        // Toggle hex section
        const hexSection = document.getElementById('hexSection');
        const toggleHex = document.getElementById('toggleHex');
        const toggleHexText = document.getElementById('toggleHexText');

        toggleHex.addEventListener('click', function(e) {
            e.preventDefault();
            const isHidden = hexSection.classList.toggle('hidden');
            toggleHexText.textContent = isHidden
                ? translations[currentLanguage].toggleHexShow
                : translations[currentLanguage].toggleHexHide;
        });

        // Validate pubkey and convert to hex
        let debounceHexTimer;
        let pubkeyIsValid = false;

        pubkeyInput.addEventListener('input', function() {
            clearTimeout(debounceHexTimer);
            pubkeyStatus.classList.add('hidden');

            debounceHexTimer = setTimeout(async function() {
                const pubkeyValue = pubkeyInput.value.trim();

                if (!pubkeyValue) {
                    hexkeyInput.value = '';
                    copyHexBtn.disabled = true;
                    pubkeyStatus.classList.add('hidden');
                    pubkeyIsValid = false;
                    return;
                }

                if (!pubkeyValue.startsWith('npub')) {
                    hexkeyInput.value = '';
                    copyHexBtn.disabled = true;
                    pubkeyIsValid = false;
                    return;
                }

                try {
                    const res = await fetch('/api/check-pubkey', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pubkey: pubkeyValue })
                    });

                    const data = await res.json();

                    if (res.ok && data.hex) {
                        hexkeyInput.value = data.hex;
                        copyHexBtn.disabled = false;

                        if (data.registered) {
                            pubkeyStatus.textContent = translations[currentLanguage].pubkeyRegistered;
                            pubkeyStatus.className = 'text-xs mt-1 text-red-400';
                            pubkeyIsValid = false;
                        } else {
                            pubkeyStatus.textContent = translations[currentLanguage].pubkeyValid;
                            pubkeyStatus.className = 'text-xs mt-1 text-green-400';
                            pubkeyIsValid = true;
                        }
                        pubkeyStatus.classList.remove('hidden');
                    } else {
                        hexkeyInput.value = '';
                        copyHexBtn.disabled = true;
                        pubkeyIsValid = false;
                    }
                } catch (err) {
                    console.error('Error checking pubkey:', err);
                    hexkeyInput.value = '';
                    copyHexBtn.disabled = true;
                    pubkeyIsValid = false;
                }
            }, 500);
        });

        // Copy hexadecimal to clipboard
        copyHexBtn.addEventListener('click', function() {
            if (hexkeyInput.value) {
                navigator.clipboard.writeText(hexkeyInput.value).then(() => {
                    const originalText = copyHexBtn.innerHTML;
                    copyHexBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                    copyHexBtn.classList.add('bg-green-600');
                    copyHexBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600');

                    setTimeout(() => {
                        copyHexBtn.innerHTML = originalText;
                        copyHexBtn.classList.remove('bg-green-600');
                        copyHexBtn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                    }, 2000);
                }).catch(err => {
                    console.error('Error copying to clipboard:', err);
                });
            }
        });

        async function verifyPayment() {
            if (!currentInvoice || isChecking) return;

            isChecking = true;
            try {
                const res = await fetch('/api/check-payment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        payment_hash: currentInvoice.payment_hash,
                        username: currentInvoice.username,
                        pubkey: currentInvoice.pubkey
                    })
                });

                const data = await res.json();

                if (data.paid) {
                    clearInterval(paymentCheckInterval);
                    paymentSection.classList.add('hidden');
                    successSection.classList.remove('hidden');
                    document.getElementById('registeredNip05').textContent = currentInvoice.username + '@' + DOMAIN;
                    loadUltimosRegistros();
                }
            } catch (err) {
                console.error('Payment verification error:', err);
            } finally {
                isChecking = false;
            }
        }

        const PAYMENT_POLL_INTERVAL_MS = 2000;
        const PAYMENT_POLL_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes, matches standard Lightning invoice expiry

        function startPaymentVerification() {
            clearInterval(paymentCheckInterval);
            clearTimeout(paymentCheckTimeout);
            document.getElementById('checkPaymentText').textContent = translations[currentLanguage].checkPaymentWaiting;
            checkPaymentBtn.disabled = true;

            paymentCheckInterval = setInterval(verifyPayment, PAYMENT_POLL_INTERVAL_MS);

            paymentCheckTimeout = setTimeout(function() {
                stopPaymentVerification();
                const checkPaymentText = document.getElementById('checkPaymentText');
                checkPaymentText.textContent = translations[currentLanguage].paymentExpired;
                checkPaymentBtn.disabled = false;
            }, PAYMENT_POLL_TIMEOUT_MS);

            verifyPayment();
        }

        function stopPaymentVerification() {
            clearInterval(paymentCheckInterval);
            clearTimeout(paymentCheckTimeout);
            paymentCheckInterval = null;
            paymentCheckTimeout = null;
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!pubkeyIsValid) {
                pubkeyStatus.textContent = translations[currentLanguage].pubkeyRegistered;
                pubkeyStatus.className = 'text-xs mt-1 text-red-400';
                pubkeyStatus.classList.remove('hidden');
                return;
            }

            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            username = usernameInput.value.toLowerCase().trim();
            pubkeyHex = pubkeyInput.value.trim();

            try {
                const res = await fetch('/api/create-invoice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        pubkey: pubkeyHex
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || translations[currentLanguage].errorCreateInvoice);
                }

                if (data.status === 'already_paid') {
                    const successSection = document.getElementById('successSection');
                    const errorSection = document.getElementById('errorSection');
                    errorSection.classList.add('hidden');
                    form.classList.add('hidden');
                    paymentSection.classList.add('hidden');
                    successSection.classList.remove('hidden');
                    document.getElementById('successNIP05').textContent = `${username}@{{ domain }}`;
                    startPaymentVerification();
                    return;
                }

                if (!data.payment_request) {
                    throw new Error(data.detail || translations[currentLanguage].errorCreateInvoice);
                }

                currentInvoice = data;

                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '<canvas id="qrCanvas" width="200" height="200"></canvas><img id="qrLogo" src="/static/images/nostr-logo-black.svg" alt="Nostr" class="qr-logo">';

                const invoiceText = document.getElementById('invoiceText');
                console.log('Payment Request:', data.payment_request);
                console.log('Payment Hash:', data.payment_hash);

                if (!data.payment_request) {
                    invoiceText.textContent = translations[currentLanguage].errorCreateInvoice;
                    throw new Error('Empty payment request received');
                }

                const canvas = document.getElementById('qrCanvas');
                const qr = new QRious({
                    element: canvas,
                    value: data.payment_request,
                    size: 200,
                    level: 'H',
                    mime: 'image/png'
                });

                invoiceText.textContent = data.payment_request;
                form.classList.add('hidden');
                paymentSection.classList.remove('hidden');
                
                // Show copy hint
                const copyHint = document.getElementById('copyHint');
                copyHint.innerHTML = '<i class="fa-solid fa-copy mr-1"></i>' + (translations[currentLanguage].copyInvoice || 'Tap to copy');
                copyHint.classList.remove('hidden');

                // Start automatic payment verification
                startPaymentVerification();

            } catch (err) {
                errorMsg.textContent = err.message;
                errorSection.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        });

        checkPaymentBtn.addEventListener('click', async function() {
            stopPaymentVerification();
            await verifyPayment();
            if (paymentSection.classList.contains('hidden')) {
                return;
            }
            startPaymentVerification();
        });

        function resetToForm() {
            stopPaymentVerification();
            currentInvoice = null;
            pubkeyIsValid = false;
            usernameInput.value = '';
            pubkeyInput.value = '';
            hexkeyInput.value = '';
            copyHexBtn.disabled = true;
            availabilityMsg.classList.add('hidden');
            pubkeyStatus.classList.add('hidden');
            paymentSection.classList.add('hidden');
            successSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            form.classList.remove('hidden');
            document.getElementById('copyHint').classList.add('hidden');
        }

        document.getElementById('backToFormBtn').addEventListener('click', resetToForm);
        document.getElementById('newRegistrationBtn').addEventListener('click', resetToForm);
        document.getElementById('invoiceWrapper').addEventListener('click', copyInvoice);

        function copyInvoice() {
            const invoiceElement = document.getElementById('invoiceText');
            if (!invoiceElement || !invoiceElement.textContent) {
                console.error('Invoice not found');
                return;
            }
            
            const invoice = invoiceElement.textContent;
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            if (isMobile) {
                const a = document.createElement('a');
                a.href = `lightning:${invoice}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                navigator.clipboard.writeText(invoice).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('Error copying invoice:', err);
                    alert('Error copying to clipboard');
                });
            }
        }

        function showCopySuccess() {
            const hint = document.getElementById('copyHint');
            const originalText = hint.innerHTML;
            hint.innerHTML = '<i class="fa-solid fa-check mr-1"></i>' + (translations[currentLanguage].copyInvoiceDone || 'Copied!');
            hint.classList.remove('hidden');
            setTimeout(() => {
                hint.innerHTML = originalText;
            }, 2000);
        }

        async function loadUltimosRegistros() {
            const container = document.getElementById('ultimosRegistros');

            function clearContainer() {
                while (container.firstChild) container.removeChild(container.firstChild);
            }

            function makeStatusDot(active, titleActive, titleInactive) {
                const span = document.createElement('span');
                span.className = active
                    ? 'w-2.5 h-2.5 rounded-full bg-green-500 inline-block flex-shrink-0'
                    : 'w-2.5 h-2.5 rounded-full bg-red-500 inline-block flex-shrink-0';
                span.title = active ? titleActive : titleInactive;
                return span;
            }

            try {
                const res = await fetch('/api/latest-records');
                const data = await res.json();
                clearContainer();

                if (!data.length) {
                    const p = document.createElement('p');
                    p.className = 'text-slate-500 text-sm py-4';
                    p.textContent = translations[currentLanguage].noRegs;
                    container.appendChild(p);
                    return;
                }

                data.slice(0, 5).forEach(r => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-[1fr_1fr_2.5rem_2.5rem] sm:grid-cols-[1fr_2fr_2.5rem_2.5rem] gap-3 sm:gap-6 py-4 items-center';

                    const nip05Cell = document.createElement('p');
                    nip05Cell.className = 'text-white text-sm font-semibold tracking-tight truncate';
                    nip05Cell.textContent = r.nip05;

                    const pubkeyCell = document.createElement('p');
                    pubkeyCell.className = 'text-slate-400 text-xs font-mono truncate sm:overflow-visible sm:whitespace-normal';
                    pubkeyCell.textContent = r.npub || '';

                    const paidCell = document.createElement('div');
                    paidCell.className = 'flex justify-center';
                    paidCell.appendChild(makeStatusDot(r.payment_completed, 'Payment completed', r.admin_only ? 'Admin' : 'Pending'));

                    const statusCell = document.createElement('div');
                    statusCell.className = 'flex justify-center';
                    statusCell.appendChild(makeStatusDot(r.in_nostr_json, 'Active in nostr.json', 'Not active in nostr.json'));

                    row.appendChild(nip05Cell);
                    row.appendChild(pubkeyCell);
                    row.appendChild(paidCell);
                    row.appendChild(statusCell);
                    container.appendChild(row);
                });
            } catch (e) {
                clearContainer();
                const p = document.createElement('p');
                p.className = 'text-slate-500 text-sm py-4';
                p.textContent = 'Could not load registrations.';
                container.appendChild(p);
            }
        }

        loadUltimosRegistros();
        
        setInterval(loadUltimosRegistros, 30000);
    </script>
</body>
</html>
